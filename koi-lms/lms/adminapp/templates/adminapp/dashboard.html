{% extends 'adminapp/base.html' %}

{% block title %}Dashboard{% endblock %}

{% block breadcrumbs %}
<li class="breadcrumb-item active" aria-current="page">Dashboard</li>
{% endblock %}

{% block content %}
<div class="page-header">
    <h1><i class="fas fa-tachometer-alt"></i> Dashboard</h1>
    <p class="text-muted mb-2">Welcome back! Here's an overview of your system.</p>
</div>

<!-- Statistics Cards -->
<div class="row g-3 mb-4">
    <div class="col-xl-3 col-lg-4 col-md-6 col-sm-6 col-12">
        <div class="stat-card primary h-100">
            <div class="d-flex align-items-start justify-content-between">
                <div class="icon">
                    <i class="fas fa-user-graduate"></i>
                </div>
                <div class="dropdown">
                    <button class="btn btn-link text-muted p-0 border-0" type="button" data-bs-toggle="dropdown">
                        <i class="fas fa-ellipsis-v"></i>
                    </button>
                    <ul class="dropdown-menu dropdown-menu-end">
                        <li><a class="dropdown-item" href="{% url 'student_list' %}">View All Students</a></li>
                        <li><a class="dropdown-item" href="{% url 'student_create' %}">Add New Student</a></li>
                    </ul>
                </div>
            </div>
            <h6 class="mt-3">Total Students</h6>
            <h2>{{ total_students }}</h2>
            <div class="d-flex justify-content-between align-items-center mt-2">
                <small class="text-muted">Active learners</small>
                <span class="badge bg-primary bg-opacity-25 text-primary">
                    <i class="fas fa-users me-1"></i>
                    <span class="d-none d-sm-inline">All</span>
                </span>
            </div>
        </div>
    </div>
    
    <div class="col-xl-3 col-lg-4 col-md-6 col-sm-6 col-12">
        <div class="stat-card success h-100">
            <div class="d-flex align-items-start justify-content-between">
                <div class="icon">
                    <i class="fas fa-book"></i>
                </div>
                <div class="dropdown">
                    <button class="btn btn-link text-muted p-0 border-0" type="button" data-bs-toggle="dropdown">
                        <i class="fas fa-ellipsis-v"></i>
                    </button>
                    <ul class="dropdown-menu dropdown-menu-end">
                        <li><a class="dropdown-item" href="{% url 'course_list' %}">View All Courses</a></li>
                        <li><a class="dropdown-item" href="{% url 'course_create' %}">Create New Course</a></li>
                    </ul>
                </div>
            </div>
            <h6 class="mt-3">Total Courses</h6>
            <h2>{{ total_courses }}</h2>
            <div class="d-flex justify-content-between align-items-center mt-2">
                <small class="text-muted">Available courses</small>
                <span class="badge bg-success bg-opacity-25 text-success">
                    <i class="fas fa-layer-group me-1"></i>
                    <span class="d-none d-sm-inline">Active</span>
                </span>
            </div>
        </div>
    </div>
    
    <div class="col-xl-3 col-lg-4 col-md-6 col-sm-6 col-12">
        <div class="stat-card warning h-100">
            <div class="d-flex align-items-start justify-content-between">
                <div class="icon">
                    <i class="fas fa-user-check"></i>
                </div>
                <div class="dropdown">
                    <button class="btn btn-link text-muted p-0 border-0" type="button" data-bs-toggle="dropdown">
                        <i class="fas fa-ellipsis-v"></i>
                    </button>
                    <ul class="dropdown-menu dropdown-menu-end">
                        <li><a class="dropdown-item" href="{% url 'enrollment_list' %}">View All Enrollments</a></li>
                        <li><a class="dropdown-item" href="#">Manage Enrollments</a></li>
                    </ul>
                </div>
            </div>
            <h6 class="mt-3">Active Enrollments</h6>
            <h2>{{ total_enrollments }}</h2>
            <div class="d-flex justify-content-between align-items-center mt-2">
                <small class="text-muted">Current semester</small>
                <span class="badge bg-warning bg-opacity-25 text-warning">
                    <i class="fas fa-calendar-alt me-1"></i>
                    <span class="d-none d-sm-inline">Current</span>
                </span>
            </div>
        </div>
    </div>
    
    <div class="col-xl-3 col-lg-4 col-md-6 col-sm-6 col-12">
        <div class="stat-card danger h-100">
            <div class="d-flex align-items-start justify-content-between">
                <div class="icon">
                    <i class="fas fa-tasks"></i>
                </div>
                <div class="dropdown">
                    <button class="btn btn-link text-muted p-0 border-0" type="button" data-bs-toggle="dropdown">
                        <i class="fas fa-ellipsis-v"></i>
                    </button>
                    <ul class="dropdown-menu dropdown-menu-end">
                        <li><a class="dropdown-item" href="{% url 'assignment_list' %}">View All Assignments</a></li>
                        <li><a class="dropdown-item" href="{% url 'assignment_create' %}">Create New Assignment</a></li>
                    </ul>
                </div>
            </div>
            <h6 class="mt-3">Assignments</h6>
            <h2>{{ total_assignments }}</h2>
            <div class="d-flex justify-content-between align-items-center mt-2">
                <small class="text-muted">Total tasks</small>
                <span class="badge bg-danger bg-opacity-25 text-danger">
                    <i class="fas fa-clipboard-check me-1"></i>
                    <span class="d-none d-sm-inline">All</span>
                </span>
            </div>
        </div>
    </div>
</div>

<!-- Performance Metrics -->
<div class="row g-3 mb-4">
    <div class="col-xl-4 col-lg-6 col-md-6 col-12">
        <div class="stat-card info h-100">
            <div class="icon">
                <i class="fas fa-chart-line"></i>
            </div>
            <h6>Average Student GPA</h6>
            <h2>{{ avg_gpa }}</h2>
            <div class="mt-2">
                <div class="progress" style="height: 6px;">
                    <div class="progress-bar bg-info" role="progressbar" 
                         style="width: {% widthratio avg_gpa 4.0 100 %}%" 
                         aria-valuenow="{{ avg_gpa }}" 
                         aria-valuemin="0" 
                         aria-valuemax="4.0">
                    </div>
                </div>
                <div class="d-flex justify-content-between mt-2">
                    <small class="text-muted">Overall performance</small>
                    <small class="text-info">
                        <i class="fas fa-arrow-up me-1"></i>
                        4.0 scale
                    </small>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Additional Metrics for larger screens -->
    <div class="col-xl-8 col-lg-6 col-md-6 col-12 d-none d-md-block">
        <div class="data-table h-100">
            <div class="p-3 border-bottom">
                <h5 class="mb-0"><i class="fas fa-chart-pie"></i> System Overview</h5>
            </div>
            <div class="p-3">
                <div class="row text-center">
                    <div class="col-4 border-end">
                        <h4 class="text-primary">{{ total_students }}</h4>
                        <small class="text-muted">Students</small>
                    </div>
                    <div class="col-4 border-end">
                        <h4 class="text-success">{{ total_courses }}</h4>
                        <small class="text-muted">Courses</small>
                    </div>
                    <div class="col-4">
                        <h4 class="text-warning">{{ total_enrollments }}</h4>
                        <small class="text-muted">Enrollments</small>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Recent Activities -->
<div class="row g-3 mb-4">
    <div class="col-xl-6 col-lg-6 col-md-12">
        <div class="data-table h-100">
            <div class="d-flex justify-content-between align-items-center p-3 border-bottom">
                <h5 class="mb-0"><i class="fas fa-clock me-2"></i> Recent Enrollments</h5>
                <a href="{% url 'enrollment_list' %}" class="btn btn-sm btn-outline-primary">
                    View All
                </a>
            </div>
            <div class="table-responsive">
                <table class="table table-hover mb-0">
                    <thead>
                        <tr>
                            <th>Student</th>
                            <th class="d-none d-sm-table-cell">Course</th>
                            <th>Date</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for enrollment in recent_enrollments %}
                        <tr>
                            <td>
                                <div class="d-flex align-items-center">
                                    <div class="avatar-sm me-2">
                                        <div class="avatar-title bg-primary bg-opacity-10 text-primary rounded-circle">
                                            {{ enrollment.student.student_id|first|upper }}
                                        </div>
                                    </div>
                                    <div>
                                        <div class="fw-medium">{{ enrollment.student.student_id }}</div>
                                        <small class="text-muted d-block d-sm-none">{{ enrollment.course.course_code|truncatechars:15 }}</small>
                                    </div>
                                </div>
                            </td>
                            <td class="d-none d-sm-table-cell">{{ enrollment.course.course_code }}</td>
                            <td>
                                <span class="badge bg-light text-dark">
                                    {{ enrollment.enrollment_date|date:"M d" }}
                                </span>
                            </td>
                        </tr>
                        {% empty %}
                        <tr>
                            <td colspan="3" class="text-center py-3">
                                <div class="text-muted">
                                    <i class="fas fa-inbox fa-2x mb-2"></i>
                                    <p class="mb-0">No recent enrollments</p>
                                </div>
                            </td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
        </div>
    </div>
    
    <div class="col-xl-6 col-lg-6 col-md-12">
        <div class="data-table h-100">
            <div class="d-flex justify-content-between align-items-center p-3 border-bottom">
                <h5 class="mb-0"><i class="fas fa-question-circle me-2"></i> Recent Queries</h5>
                <a href="#" class="btn btn-sm btn-outline-primary">
                    View All
                </a>
            </div>
            <div class="table-responsive">
                <table class="table table-hover mb-0">
                    <thead>
                        <tr>
                            <th>Student</th>
                            <th class="d-none d-md-table-cell">Intent</th>
                            <th>Status</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for query in recent_queries %}
                        <tr>
                            <td>
                                <div class="d-flex align-items-center">
                                    {% if query.student %}
                                    <div class="avatar-sm me-2">
                                        <div class="avatar-title bg-info bg-opacity-10 text-info rounded-circle">
                                            {{ query.student.student_id|first|upper }}
                                        </div>
                                    </div>
                                    {% endif %}
                                    <div>
                                        <div class="fw-medium">{{ query.student.student_id|default:"Anonymous" }}</div>
                                        <small class="text-muted d-block d-md-none">{{ query.intent|truncatechars:20 }}</small>
                                    </div>
                                </div>
                            </td>
                            <td class="d-none d-md-table-cell">{{ query.intent|truncatechars:30 }}</td>
                            <td>
                                <span class="status-badge status-{% if query.status == 'Resolved' %}active{% else %}pending{% endif %}">
                                    {{ query.status }}
                                </span>
                            </td>
                        </tr>
                        {% empty %}
                        <tr>
                            <td colspan="3" class="text-center py-3">
                                <div class="text-muted">
                                    <i class="fas fa-comments fa-2x mb-2"></i>
                                    <p class="mb-0">No recent queries</p>
                                </div>
                            </td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
        </div>
    </div>
</div>

<!-- Quick Actions -->
<div class="row mb-4">
    <div class="col-12">
        <div class="page-header">
            <div class="d-flex justify-content-between align-items-center">
                <div>
                    <h5 class="mb-0"><i class="fas fa-bolt me-2"></i> Quick Actions</h5>
                    <p class="text-muted mb-0 mt-1">Frequently used actions</p>
                </div>
                <button class="btn btn-outline-primary d-none d-md-block" onclick="toggleQuickActions()">
                    <i class="fas fa-ellipsis-h"></i>
                </button>
            </div>
            
            <div class="row g-2 mt-3" id="quickActions">
                <div class="col-auto">
                    <a href="{% url 'student_create' %}" class="btn btn-primary-custom btn-custom">
                        <i class="fas fa-user-plus me-1"></i>
                        <span class="d-none d-sm-inline">Add Student</span>
                        <span class="d-inline d-sm-none">Student</span>
                    </a>
                </div>
                <div class="col-auto">
                    <a href="{% url 'course_create' %}" class="btn btn-success btn-custom">
                        <i class="fas fa-book-medical me-1"></i>
                        <span class="d-none d-sm-inline">Create Course</span>
                        <span class="d-inline d-sm-none">Course</span>
                    </a>
                </div>
                <div class="col-auto">
                    <a href="{% url 'assignment_create' %}" class="btn btn-warning btn-custom">
                        <i class="fas fa-plus-square me-1"></i>
                        <span class="d-none d-sm-inline">New Assignment</span>
                        <span class="d-inline d-sm-none">Assignment</span>
                    </a>
                </div>
                <div class="col-auto">
                    <a href="{% url 'quiz_create' %}" class="btn btn-info btn-custom d-none d-md-inline-block">
                        <i class="fas fa-file-alt me-1"></i> New Quiz
                    </a>
                </div>
            </div>
            
            <!-- Mobile Quick Actions Grid -->
            <div class="row g-3 mt-3 d-md-none">
                <div class="col-6">
                    <a href="{% url 'student_list' %}" class="card h-100 text-decoration-none">
                        <div class="card-body text-center p-3">
                            <div class="avatar-lg mx-auto mb-2">
                                <div class="avatar-title bg-primary bg-opacity-10 text-primary rounded-circle">
                                    <i class="fas fa-users fa-lg"></i>
                                </div>
                            </div>
                            <h6 class="mb-0">All Students</h6>
                        </div>
                    </a>
                </div>
                <div class="col-6">
                    <a href="{% url 'course_list' %}" class="card h-100 text-decoration-none">
                        <div class="card-body text-center p-3">
                            <div class="avatar-lg mx-auto mb-2">
                                <div class="avatar-title bg-success bg-opacity-10 text-success rounded-circle">
                                    <i class="fas fa-book fa-lg"></i>
                                </div>
                            </div>
                            <h6 class="mb-0">All Courses</h6>
                        </div>
                    </a>
                </div>
                <div class="col-6">
                    <a href="{% url 'assignment_list' %}" class="card h-100 text-decoration-none">
                        <div class="card-body text-center p-3">
                            <div class="avatar-lg mx-auto mb-2">
                                <div class="avatar-title bg-warning bg-opacity-10 text-warning rounded-circle">
                                    <i class="fas fa-tasks fa-lg"></i>
                                </div>
                            </div>
                            <h6 class="mb-0">Assignments</h6>
                        </div>
                    </a>
                </div>
                <div class="col-6">
                    <a href="{% url 'enrollment_list' %}" class="card h-100 text-decoration-none">
                        <div class="card-body text-center p-3">
                            <div class="avatar-lg mx-auto mb-2">
                                <div class="avatar-title bg-danger bg-opacity-10 text-danger rounded-circle">
                                    <i class="fas fa-user-check fa-lg"></i>
                                </div>
                            </div>
                            <h6 class="mb-0">Enrollments</h6>
                        </div>
                    </a>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Empty State for Mobile -->
<div class="d-md-none">
    <div class="alert alert-info">
        <div class="d-flex align-items-center">
            <i class="fas fa-info-circle fa-lg me-3"></i>
            <div>
                <h6 class="mb-1">Mobile View Active</h6>
                <p class="mb-0">Swipe left/right on tables to view more content. Tap cards for details.</p>
            </div>
        </div>
    </div>
</div>

<style>
    /* Additional responsive styles for dashboard */
    .avatar-sm {
        width: 32px;
        height: 32px;
        display: flex;
        align-items: center;
        justify-content: center;
    }
    
    .avatar-lg {
        width: 48px;
        height: 48px;
        display: flex;
        align-items: center;
        justify-content: center;
    }
    
    .avatar-title {
        width: 100%;
        height: 100%;
        display: flex;
        align-items: center;
        justify-content: center;
        font-weight: 600;
    }
    
    .card {
        border: 1px solid rgba(0,0,0,0.08);
        transition: all 0.3s;
        border-radius: 10px;
    }
    
    .card:hover {
        transform: translateY(-2px);
        box-shadow: 0 4px 15px rgba(0,0,0,0.1);
    }
    
    /* Responsive table adjustments */
    @media (max-width: 576px) {
        .data-table {
            margin: 0 -12px;
            border-radius: 0;
            box-shadow: none;
            border: 1px solid #dee2e6;
        }
        
        .page-header {
            padding: 15px;
        }
        
        .stat-card h2 {
            font-size: 24px;
        }
        
        .stat-card .icon {
            width: 40px;
            height: 40px;
            font-size: 18px;
        }
    }
    
    @media (max-width: 768px) {
        .stat-card {
            margin-bottom: 0;
        }
        
        .table-responsive {
            -webkit-overflow-scrolling: touch;
        }
    }
    
    @media (max-width: 992px) {
        .stat-card h2 {
            font-size: 26px;
        }
    }
    
    /* Hide/show elements based on screen size */
    @media (min-width: 1200px) {
        .stat-card h2 {
            font-size: 32px;
        }
    }
</style>

<script>
    // Toggle quick actions on mobile
    function toggleQuickActions() {
        const quickActions = document.getElementById('quickActions');
        quickActions.classList.toggle('d-none');
    }
    
    // Add swipe functionality for mobile tables
    document.addEventListener('DOMContentLoaded', function() {
        // Initialize tooltips
        const tooltipTriggerList = [].slice.call(document.querySelectorAll('[data-bs-toggle="tooltip"]'));
        tooltipTriggerList.map(function (tooltipTriggerEl) {
            return new bootstrap.Tooltip(tooltipTriggerEl);
        });
        
        // Add swipe detection for mobile tables
        let touchStartX = 0;
        let touchEndX = 0;
        
        const tables = document.querySelectorAll('.table-responsive');
        tables.forEach(table => {
            table.addEventListener('touchstart', e => {
                touchStartX = e.changedTouches[0].screenX;
            }, false);
            
            table.addEventListener('touchend', e => {
                touchEndX = e.changedTouches[0].screenX;
                handleSwipe(table);
            }, false);
        });
        
        function handleSwipe(element) {
            const swipeThreshold = 50;
            const swipeDistance = touchEndX - touchStartX;
            
            if (Math.abs(swipeDistance) > swipeThreshold) {
                element.scrollLeft -= swipeDistance * 2;
            }
        }
        
        // Auto-hide quick actions on mobile after 5 seconds
        if (window.innerWidth < 768) {
            setTimeout(() => {
                const mobileInfo = document.querySelector('.d-md-none .alert-info');
                if (mobileInfo) {
                    mobileInfo.classList.add('fade');
                    setTimeout(() => {
                        mobileInfo.style.display = 'none';
                    }, 500);
                }
            }, 5000);
        }
    });
</script>
{% endblock %}